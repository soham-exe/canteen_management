<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Menu Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Admin Panel</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'admin_dashboard' %}active{% endif %}" href="{{ url_for('admin_dashboard') }}">Live Orders</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'admin_menu' %}active{% endif %}" href="{{ url_for('admin_menu') }}">Menu Management</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'admin_completed_orders' %}active{% endif %}" href="{{ url_for('admin_completed_orders') }}">Sales History</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Manage Menu Items</h2>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#itemModal" data-action="add">
                <i class="fas fa-plus"></i> Add New Item
            </button>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <table class="table table-striped mt-3">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Prep Time (min)</th>
                    <th>Image File</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in menu_items %}
                <tr>
                    <td>{{ item.item_id }}</td>
                    <td>{{ item.name }}</td>
                    <td>₹{{ "%.2f"|format(item.price) }}</td>
                    <td>{{ item.preparation_time }}</td>
                    <td>{{ item.image_url }}</td>
                    <td>
                        <button class="btn btn-sm btn-info text-white" 
                                data-bs-toggle="modal" 
                                data-bs-target="#itemModal"
                                data-action="edit"
                                data-id="{{ item.item_id }}"
                                data-name="{{ item.name }}"
                                data-desc="{{ item.description }}"
                                data-price="{{ item.price }}"
                                data-time="{{ item.preparation_time }}"
                                data-img="{{ item.image_url }}">
                            <i class="fas fa-edit"></i> Edit
                        </button>

                        <form action="{{ url_for('delete_menu_item', item_id=item.item_id) }}" method="POST" class="d-inline" onsubmit="return confirm('Delete \'{{ item.name }}\'? This cannot be undone.');">
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Modal for Adding/Editing Menu Items -->
    <div class="modal fade" id="itemModal" tabindex="-1" aria-labelledby="itemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="itemForm" method="POST">
                    <input type="hidden" name="item_id" id="modal-item-id"> 
                    
                    <div class="modal-header">
                        <h5 class="modal-title" id="itemModalLabel">Add New Item</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="modal-name" class="form-label">Name</label>
                            <input type="text" name="name" id="modal-name" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="modal-description" class="form-label">Description</label>
                            <textarea name="description" id="modal-description" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="modal-price" class="form-label">Price (₹)</label>
                            <input type="number" step="0.01" min="0" name="price" id="modal-price" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="modal-time" class="form-label">Prep Time (minutes)</label>
                            <input type="number" min="1" name="preparation_time" id="modal-time" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="modal-img" class="form-label">Image Filename (e.g., samosa.jpg)</label>
                            <input type="text" name="image_url" id="modal-img" class="form-control">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="modal-submit-btn">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        /**
         * Handles dynamic content population of the Add/Edit Item modal
         * based on the button clicked ('Add New Item' or 'Edit').
         */
        const itemModal = document.getElementById('itemModal');
        itemModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget; // Button that triggered the modal
            const action = button.getAttribute('data-action');
            const form = document.getElementById('itemForm');
            
            // Clear the hidden item_id field initially
            document.getElementById('modal-item-id').value = ''; 
            document.getElementById('modal-item-id').disabled = false; // Ensure it's enabled by default

            if (action === 'add') {
                // Configure modal for adding a new item
                document.getElementById('itemModalLabel').textContent = 'Add New Item';
                form.action = "{{ url_for('add_menu_item') }}";
                form.reset(); // Clear form fields
                document.getElementById('modal-submit-btn').textContent = 'Add Item';
                // Disable item_id field for 'Add' as it's auto-generated
                document.getElementById('modal-item-id').disabled = true;

            } else if (action === 'edit') {
                // Configure modal for editing an existing item
                document.getElementById('itemModalLabel').textContent = 'Edit Item';
                
                // Extract item data stored in the 'Edit' button's data-* attributes
                const itemId = button.getAttribute('data-id');
                const itemName = button.getAttribute('data-name');
                const itemDesc = button.getAttribute('data-desc');
                const itemPrice = button.getAttribute('data-price');
                const itemTime = button.getAttribute('data-time');
                const itemImg = button.getAttribute('data-img');

                // Populate the form fields with the existing item data
                document.getElementById('modal-item-id').value = itemId;
                document.getElementById('modal-name').value = itemName;
                document.getElementById('modal-description').value = itemDesc;
                document.getElementById('modal-price').value = itemPrice;
                document.getElementById('modal-time').value = itemTime;
                document.getElementById('modal-img').value = itemImg;
                
                // Construct the correct form action URL using a safe placeholder
                const baseUrl = "{{ url_for('edit_menu_item', item_id=0) }}"; // Use 0 as placeholder
                form.action = baseUrl.replace('/0', '/' + itemId); // Replace placeholder with actual ID
                
                document.getElementById('modal-submit-btn').textContent = 'Update Item';
                // Ensure item_id field is enabled so it's submitted for the update
                document.getElementById('modal-item-id').disabled = false; 
            }
        });
    </script>
</body>
</html>